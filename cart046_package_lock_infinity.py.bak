# cart046_package_lock_infinity.py
"""
Cart 046: Package-Lock Infinity
Anchors co-invention/IP provenance for Infinity + GPT collaboration.
- Records contributors, statements, timestamps, and hashes
- Emits a lock manifest that downstream carts reference
- Provides verification (rehash) and append-only notes

CLI:
  python cart046_package_lock_infinity.py lock --contributors "Kris,Copilot" --statement "Co-invented Infinity AI stack"
  python cart046_package_lock_infinity.py verify
  python cart046_package_lock_infinity.py note --text "Added robotics factory orchestrator"
  python cart046_package_lock_infinity.py export
"""

import os, sys, json, time, hashlib

ROOT = os.path.dirname(os.path.abspath(__file__))
LOGS = os.path.join(ROOT, "logs")
ART  = os.path.join(ROOT, "artifacts")
DATA = os.path.join(ROOT, "data")
os.makedirs(LOGS, exist_ok=True); os.makedirs(ART, exist_ok=True); os.makedirs(DATA, exist_ok=True)

AUDIT = os.path.join(LOGS, "package_lock_infinity_audit.jsonl")
LOCK  = os.path.join(DATA, "package_lock_infinity.json")

DEFAULT_LOCK = {"contributors": [], "statement": "", "created": "", "hash": "", "notes": []}

def now(): return time.strftime("%Y-%m-%dT%H:%M:%S", time.gmtime())
def audit(e): e=dict(e); e["t"]=now(); 
with open(AUDIT,"a",encoding="utf-8") as f: f.write(json.dumps(e)+"\n")

def load():
    if not os.path.exists(LOCK): return DEFAULT_LOCK.copy()
    try:
        with open(LOCK,"r",encoding="utf-8") as f: return json.load(f)
    except: return DEFAULT_LOCK.copy()

def save(obj):
    with open(LOCK,"w",encoding="utf-8") as f: json.dump(obj,f,indent=2)

def artifact(name,obj):
    p=os.path.join(ART,f"{name}.json")
    with open(p,"w",encoding="utf-8") as f: json.dump(obj,f,indent=2)
    return p

def make_lock(contributors: list, statement: str):
    obj = {"contributors": contributors, "statement": statement, "created": now()}
    h = hashlib.sha256(json.dumps(obj, sort_keys=True).encode("utf-8")).hexdigest()
    obj["hash"] = h; obj["notes"] = []
    save(obj)
    path = artifact("package_lock_infinity", obj)
    audit({"action":"lock.make","contributors":contributors})
    print(json.dumps({"ok":True,"path":path,"hash":h}, indent=2))

def verify():
    obj = load()
    h2 = hashlib.sha256(json.dumps({"contributors": obj["contributors"], "statement": obj["statement"], "created": obj["created"]}, sort_keys=True).encode("utf-8")).hexdigest()
    ok = (h2 == obj.get("hash",""))
    audit({"action":"lock.verify","ok":ok})
    path = artifact("package_lock_verify", {"ok": ok, "expected": obj.get("hash",""), "actual": h2})
    print(json.dumps({"ok":ok,"path":path}, indent=2))

def note(text: str):
    obj = load()
    obj.setdefault("notes", []).append({"text": text, "t": now()})
    save(obj)
    path = artifact("package_lock_note", {"text": text, "t": now()})
    audit({"action":"lock.note"})
    print(json.dumps({"ok":True,"path":path}, indent=2))

def export():
    obj = load()
    path = artifact("package_lock_export", obj)
    audit({"action":"lock.export","notes":len(obj.get('notes',[]))})
    print(json.dumps({"ok":True,"path":path}, indent=2))

def main():
    a=sys.argv[1:]
    if not a:
        print("Usage: lock --contributors 'A,B' --statement '...' | verify | note --text '...' | export")
        return
    if a[0]=="lock":
        contributors=[]; statement=""
        for i,x in enumerate(a):
            if x=="--contributors" and i+1<len(a): contributors=[p.strip() for p in a[i+1].split(",")]
            if x=="--statement" and i+1<len(a): statement=a[i+1]
        make_lock(contributors, statement); return
    if a[0]=="verify": verify(); return
    if a[0]=="note":
        text=""
        for i,x in enumerate(a):
            if x=="--text" and i+1<len(a): text=a[i+1]
        note(text); return
    if a[0]=="export": export(); return
    print("Unknown command.")

if __name__=="__main__": main()